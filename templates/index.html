<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>G·ª£i √Ω Phim</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .autocomplete-container {
            position: relative;
        }
        .autocomplete-items {
            position: absolute;
            border: 1px solid #d4d4d4;
            border-bottom: none;
            border-top: none;
            z-index: 99;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 300px;
            overflow-y: auto;
            background-color: #fff;
        }
        .autocomplete-items div {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #d4d4d4;
        }
        .autocomplete-items div:hover {
            background-color: #e9e9e9;
        }
        .autocomplete-active {
            background-color: #0d6efd !important;
            color: #ffffff;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container py-4">
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4 shadow">
            <div class="container">
              <a class="navbar-brand fw-bold" href="/">üçø H·ªá th·ªëng G·ª£i √Ω Phim</a>
            </div>
        </nav>
        <a href="/predict" class="btn btn-link mb-3">‚Üí D·ª± ƒëo√°n ƒê√°nh gi√°</a>

        <h1 class="mb-4">Xem ƒê√°nh gi√° c·ªßa Ng∆∞·ªùi d√πng v√† G·ª£i √Ω Phim</h1>
        
        <form method="POST" class="card p-4 shadow-sm mb-4" id="userForm">
            <div class="mb-3 autocomplete-container">
                <label for="user_id_input" class="form-label">Nh·∫≠p User ID:</label>
                <input type="text" id="user_id_input" class="form-control" placeholder="Nh·∫≠p √≠t nh·∫•t 2 k√Ω t·ª± ƒë·ªÉ t√¨m ki·∫øm..." autocomplete="off">
                <input type="hidden" name="user_id" id="user_id">
                <div id="autocomplete-list" class="autocomplete-items"></div>
            </div>
            <button type="submit" class="btn btn-primary" id="submitBtn" disabled>G·ª≠i</button>
        </form>

        <div id="loading" class="text-center d-none">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">ƒêang t·∫£i...</span>
            </div>
            <p>ƒêang t·∫£i g·ª£i √Ω phim...</p>
        </div>

        {% if recommended_movies %}
        <div class="mb-5">
            <h2 class="mb-3">G·ª£i √Ω cho <span class="text-primary">"{{ request.form.user_id if request.form.user_id else '' }}"</span></h2>
            <div class="row row-cols-1 row-cols-md-5 g-3">
                {% for movie in recommended_movies %}
                <div class="col">
                    <div class="card h-100 text-center">
                        <img src="{{ movie['image'] }}" class="card-img-top" alt="{{ movie['title'] }}" style="object-fit: contain; height: 200px;">
                        <div class="card-body">
                            <h5 class="card-title">{{ movie['title'] }}</h5>
                            <div class="mb-2">
                                <span class="badge bg-secondary">{{ movie['year'] }}</span>
                                <br>
                                <span class="badge bg-info">
                                    {{ movie['genres'][:30] ~ ('...' if movie['genres']|length > 30 else '') }}
                                </span>                            
                            </div>
                            <p>ƒê√°nh gi√° trung b√¨nh: {{ movie['rating'] }} ‚≠ê ({{ movie['numrate'] }} l∆∞·ª£t)</p>
                            <p>ƒê√°nh gi√° d·ª± ƒëo√°n: {{ movie['predicted_rating'] }} ‚≠ê</p>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {% if user_ratings is not none and not user_ratings.empty %}
        <div class="mb-5">
            <h2 class="mb-3">L·ªãch s·ª≠ ƒê√°nh gi√°</h2>
            <table class="table table-bordered table-striped">
                <thead class="table-light">
                    <tr>
                        <th>Ti√™u ƒë·ªÅ</th>
                        <th>ƒê√°nh gi√°</th>
                    </tr>
                </thead>
                <tbody>
                    {% for rating in user_ratings.itertuples() %}
                    <tr>
                        <td>{{ movies_df[movies_df['ID'] == rating.MovieID]['Title'].values[0] if not movies_df[movies_df['ID'] == rating.MovieID].empty else rating.MovieID }}</td>
                        <td>{{ rating.Rating }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>

    <script>
        
        document.addEventListener('DOMContentLoaded', function() {
            const userInput = document.getElementById('user_id_input');
            const userIdField = document.getElementById('user_id');
            const autoCompleteList = document.getElementById('autocomplete-list');
            const submitBtn = document.getElementById('submitBtn');
            const form = document.getElementById('userForm');
            const loadingIndicator = document.getElementById('loading');
            
            let debounceTimer;
            
            userInput.addEventListener('input', function() {
                clearTimeout(debounceTimer);
                
                // X√≥a gi√° tr·ªã user_id v√† v√¥ hi·ªáu h√≥a n√∫t Submit khi input thay ƒë·ªïi
                userIdField.value = '';
                submitBtn.disabled = true;
                
                // T·∫°o ƒë·ªô tr·ªÖ 300ms tr∆∞·ªõc khi g·ª≠i y√™u c·∫ßu t√¨m ki·∫øm
                debounceTimer = setTimeout(() => {
                    const query = userInput.value.trim();
                    
                    if (query.length < 2) {
                        autoCompleteList.innerHTML = '';
                        return;
                    }
                    
                    // Trong m·ªôt ·ª©ng d·ª•ng th·ª±c t·∫ø, b·∫°n s·∫Ω g·ªçi API ·ªü ƒë√¢y
                    fetchUsers(query);
                }, 300);
            });
            
            form.addEventListener('submit', function(e) {
                loadingIndicator.classList.remove('d-none');
            });
            
            function fetchUsers(query) {
                // Trong ·ª©ng d·ª•ng th·ª±c t·∫ø, ƒë√¢y s·∫Ω l√† m·ªôt y√™u c·∫ßu fetch API
                fetch(`/api/search_users?query=${encodeURIComponent(query)}`)
                   .then(response => response.json())
                   .then(data => showSuggestions(data))
                   .catch(error => {
                       console.error('Error fetching users:', error);
                       // Fallback ƒë·∫øn m√¥ ph·ªèng n·∫øu API th·∫•t b·∫°i
                       simulateApiResponse(query);
                   });
            }
            
            function simulateApiResponse(query) {
                // ƒê√¢y ch·ªâ l√† m√¥ ph·ªèng - s·∫Ω ƒë∆∞·ª£c s·ª≠ d·ª•ng n·∫øu API th·∫•t b·∫°i
                setTimeout(() => {
                    // Gi·∫£ l·∫≠p m·ªôt s·ªë ng∆∞·ªùi d√πng m·∫´u v·ªõi th√¥ng tin chi ti·∫øt
                    const sampleUsers = [
                        { username: 'user1', gender: 'Male', age: 25, occupation: 'Engineer' },
                        { username: 'user2', gender: 'Female', age: 30, occupation: 'Teacher' },
                        { username: 'user3', gender: 'Male', age: 45, occupation: 'Doctor' },
                        { username: 'user4', gender: 'Female', age: 28, occupation: 'Artist' },
                        { username: 'user5', gender: 'Male', age: 35, occupation: 'Developer' }
                    ];
                    
                    const filteredUsers = sampleUsers.filter(user => 
                        user.username.toLowerCase().includes(query.toLowerCase())
                    );
                    
                    showSuggestions(filteredUsers);
                }, 200);
            }
            
            function showSuggestions(users) {
                autoCompleteList.innerHTML = '';
                
                if (users.length === 0) {
                    const div = document.createElement('div');
                    div.innerHTML = 'Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng n√†o';
                    autoCompleteList.appendChild(div);
                    return;
                }
                
                users.forEach(user => {
                    const div = document.createElement('div');
                    
                    // Ki·ªÉm tra xem user l√† chu·ªói ƒë∆°n gi·∫£n hay object v·ªõi th√¥ng tin chi ti·∫øt
                    if (typeof user === 'string') {
                        div.innerHTML = `<strong>${user}</strong>`;
                        div.addEventListener('click', function() {
                            userInput.value = user;
                            userIdField.value = user;
                            autoCompleteList.innerHTML = '';
                            submitBtn.disabled = false;
                        });
                    } else {
                        // Hi·ªÉn th·ªã th√¥ng tin chi ti·∫øt c·ªßa ng∆∞·ªùi d√πng
                        div.innerHTML = `
                            <div>
                                <strong>${user.username}</strong>
                                <div class="small text-muted">
                                    ${user.gender}, ${user.age} tu·ªïi, ${user.occupation}
                                </div>
                            </div>
                        `;
                        div.addEventListener('click', function() {
                            userInput.value = user.username;
                            userIdField.value = user.username;
                            autoCompleteList.innerHTML = '';
                            submitBtn.disabled = false;
                        });
                    }
                    
                    autoCompleteList.appendChild(div);
                });
            }
            
            // ƒê√≥ng danh s√°ch g·ª£i √Ω khi click ra ngo√†i
            document.addEventListener('click', function(e) {
                if (e.target !== userInput) {
                    autoCompleteList.innerHTML = '';
                }
            });
        });
    </script>
</body>
</html>